name: âš¡ï¸ Sync PR Assets to Design

on:
  pull_request:
    branches:
      - develop
    types: [opened, synchronize]
    paths:
      - '**/Assets.xcassets/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  preview-assets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Target (design)
        uses: actions/checkout@v4
        with:
          ref: design
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest Design
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull origin design --rebase || true
          
      - name: Fetch PR Source Branch
        run: |
          git fetch origin ${{ github.head_ref }}

      - name: Checkout Assets from PR Source
        run: |
          if git checkout origin/${{ github.head_ref }} -- mirroringBooth/mirroringBooth/Resources/Assets.xcassets; then
            echo "âœ… PR(${{ github.head_ref }})ì˜ ì—ì…‹ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤."
          else
            echo "âš ï¸ ì—ì…‹ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

      - name: Commit and Push to Design
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status --porcelain) ]]; then
            git pull origin design --rebase || true
            
            git add .
            git commit -m "ğŸ¨ [PR-Preview] PR #${{ github.event.pull_request.number }} ì—ì…‹ ì ìš©

            Source: ${{ github.head_ref }}
            Commit: ${{ github.event.pull_request.head.sha }}"
            
            for i in {1..3}; do
              if git push origin design; then
                echo "ğŸš€ design ë¸Œëœì¹˜ì— í”„ë¦¬ë·° ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
                break
              else
                echo "âš ï¸ Push ì‹¤íŒ¨, ì¬ì‹œë„ ì¤‘... ($i/3)"
                git pull origin design --rebase
                sleep 2
              fi
            done
          else
            echo "ğŸ¤·â€â™‚ï¸ ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: Comment on PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ¨ ì—ì…‹ì´ `design` ë¸Œëœì¹˜ì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤!âœ¨'
            })
