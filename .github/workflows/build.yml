name: build workflow

on:
  pull_request:
    branches: [ develop ]

jobs:
  build:
    name: Build (iOS + watchOS)
    runs-on: macos-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - scheme: mirroringBooth
            platform: iOS Simulator
            os: "17.0"
          - scheme: mirroringBoothWatch
            platform: watchOS Simulator
            os: "11.2"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build
        working-directory: mirroringBooth
        env:
          SCHEME: ${{ matrix.scheme }}
          PLATFORM: ${{ matrix.platform }}
          OS: ${{ matrix.os }}
        run: |
          set -euo pipefail

          echo "Scheme: ${SCHEME}"
          echo "Destination: platform=${PLATFORM},OS=${OS}"

          xcodebuild build \
            -scheme "${SCHEME}" \
            -project "mirroringBooth.xcodeproj" \
            -destination "platform=${PLATFORM},OS=${OS}"

      - name: Notify Slack on failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SCHEME: ${{ matrix.scheme }}
          PLATFORM: ${{ matrix.platform }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          set -euo pipefail

          if [ -z "${SLACK_WEBHOOK_URL}" ]; then
            echo "SLACK_WEBHOOK_URL secret is not set"
            exit 1
          fi

          payload=$(cat <<EOF
          {
            "text": ":x: CI 실패\n- repo: ${GITHUB_REPOSITORY}\n- workflow: ${GITHUB_WORKFLOW}\n- scheme: ${SCHEME}\n- platform: ${PLATFORM}\n- pr: ${PR_URL}\n- run: ${RUN_URL}"
          }
          EOF
          )

          curl -X POST -H 'Content-type: application/json' \
            --data "${payload}" \
            "${SLACK_WEBHOOK_URL}"
