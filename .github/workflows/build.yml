name: build workflow

on:
  pull_request:
    branches: [ develop ]

jobs:
  build:
    name: Build (iOS + watchOS)
    runs-on: macos-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - scheme: mirroringBooth
            platform: iOS Simulator
            os_major: "18"
          - scheme: mirroringBoothWatch
            platform: watchOS Simulator
            os_major: "11"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Simulator
        working-directory: mirroringBooth
        env:
          PLATFORM: ${{ matrix.platform }}
          OS_MAJOR: ${{ matrix.os_major }}
        run: |
          set -euo pipefail

          echo "Searching for destination (platform=${PLATFORM}, OS major=${OS_MAJOR}, arch=arm64)"

          destinationLine=$(xcodebuild -showdestinations \
            -scheme "${{ matrix.scheme }}" \
            -project "mirroringBooth.xcodeproj" | \
            grep -E "\\{[[:space:]]*platform:[[:space:]]*${PLATFORM}," | \
            grep -E "arch:[[:space:]]*arm64" | \
            grep -E "OS:[[:space:]]*${OS_MAJOR}\\." | \
            if [ "${PLATFORM}" = "iOS Simulator" ]; then grep -E "name:[[:space:]]*iPhone"; else cat; fi | \
            head -1)

          if [ -z "${destinationLine}" ]; then
            echo "❌ No destination found for platform=${PLATFORM}, OS major=${OS_MAJOR}, arch=arm64"
            echo "Available destinations:"
            xcodebuild -showdestinations -scheme "${{ matrix.scheme }}" -project "mirroringBooth.xcodeproj"
            exit 1
          fi

          deviceName=$(echo "${destinationLine}" | \
            sed -E 's/.*name:[[:space:]]*([^}]+)\}.*/\1/' | \
            sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

          if [ -z "${deviceName}" ]; then
            echo "❌ Failed to parse simulator name from destination line: ${destinationLine}"
            exit 1
          fi

          echo "✅ Using simulator: ${deviceName}"
          echo "device=${deviceName}" >> "$GITHUB_OUTPUT"
        id: sim

      - name: Build
        working-directory: mirroringBooth
        env:
          SCHEME: ${{ matrix.scheme }}
          PLATFORM: ${{ matrix.platform }}
          DEVICE: ${{ steps.sim.outputs.device }}
        run: |
          set -euo pipefail

          echo "Scheme: ${SCHEME}"
          echo "Destination: platform=${PLATFORM},name=${DEVICE}"

          xcodebuild build \
            -scheme "${SCHEME}" \
            -project "mirroringBooth.xcodeproj" \
            -destination "platform=${PLATFORM},name=${DEVICE}"

      - name: Notify Slack on failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SCHEME: ${{ matrix.scheme }}
          PLATFORM: ${{ matrix.platform }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          set -euo pipefail

          if [ -z "${SLACK_WEBHOOK_URL}" ]; then
            echo "SLACK_WEBHOOK_URL secret is not set"
            exit 1
          fi

          payload=$(cat <<EOF
          {
            "text": ":x: CI 실패\n- repo: ${GITHUB_REPOSITORY}\n- workflow: ${GITHUB_WORKFLOW}\n- scheme: ${SCHEME}\n- platform: ${PLATFORM}\n- pr: ${PR_URL}\n- run: ${RUN_URL}"
          }
          EOF
          )

          curl -X POST -H 'Content-type: application/json' \
            --data "${payload}" \
            "${SLACK_WEBHOOK_URL}"
